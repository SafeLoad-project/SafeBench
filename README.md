# SafeBench
SafeBench, an industrial-grade benchmark open-sourced to advance academic research on preemptively identifying memory-overloading (MO) queries. SafeBench was curated by the [AnalyticDB](https://www.alibabacloud.com/en/product/analyticdb-for-mysql) team following rigorous data quality assessment and thorough removal of anomalous data.

| Subset | \#(Queries) | \#(Clusters) | \#(Pos.) | Data Size |    G1    |    G2    |
|:------:|:-----------:|:------------:|:--------:|:---------:|:--------:|:--------:|
|   A1   |  52,080,130 |      854     |   4,014  |   30 GB   | training |          |
|   A2   |  50,856,068 |      862     |   2,508  |   29 GB   |  testing | training |
|   A3   |  48,821,677 |      856     |   2,331  |   28 GB   |          |  testing |

The Table outlines the specifications of SafeBench, which is constructed from real-world production data collected from Alibaba Cloud's data warehouse AnalyticDB. The dataset spans three continuous days, forming three distinct subsets: SafeBench A1 (Day 1), A2 (Day 2), and A3 (Day 3). These subsets include over 150 million analytical queries executed across more than 800 production database clusters. The average CPU time per query is 7.9 seconds (A1), 8.6 seconds (A2), and 8.6 seconds (A3), respectively. 
To assess the effectiveness of MO query detection methods, we divide the datasets into two evaluation groups.
Group G1 uses A1 for training and A2 for testing, while Group G2 uses A2 for training and A3 for testing. 
By default, SafeBench uses the data from the previous day for training and the data from the current day for testing, reflecting the practical deployment setting in AnalyticDB where both models and heuristic rules are updated on a daily basis. Of course, researchers are free to combine data from A1, A2, and A3 as training or testing sets according to their own experimental needs.

## Feature Set
SafeBench provides detailed profiling for each query from both the query-level and the cluster-level perspectives. Each query is uniquely identified by a query ID with a submission timestamp, and is annotated with metadata such as cluster name, total CPU time, and a binary label indicating whether memory overload occurred. Each query is further represented by a 163-dimensional feature vector, comprising 147 query-level features and 16 cluster-level features. 

A categorized summary of the features is provided in following table.
| Category      | Feature Group                    | Description                                                                                                                                                                                                                                                                                     | Count |
|---------------|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----:|
| Query-level   | Operator Count                   | Number of distinct operators (23 types in total), such as the count of \texttt{join} nodes in the query.                                                                                                                                                                                        |   23  |
|               | Operator \newline Cardinality    | Cardinality statistics for 13 operators, covering 8 metrics per operator, including total and maximum values of the output size and row count. These operators are selected based on error reports from MO queries.                                                                             |  104  |
|               | Memory-intensive Operators       | Fine-grained features of operators typically associated with high memory usage (i.e., \texttt{join}, \texttt{aggregation}, \texttt{window}, \texttt{sort}); includes child node cardinality for \texttt{join} and total number of \texttt{varchar}-typed grouping keys in \texttt{aggregation}. |   19  |
|               | Execution \newline Configuration | Configuration information during query execution scheduling, including the total degree of query parallelism and an indicator of whether the SQL query explicitly specifies an execution mode (e.g., \texttt{batch} mode), which may impact memory behavior.                                    |   2   |
| Cluster-level | Resource Metrics                 | Cluster resource usage metrics collected at 1-minute granularity, including QPS, average memory pool utilization, and CPU utilization.                                                                                                                                                          |   8   |
|               | Cluster Configuration            | Static configuration of the provisioned cluster, including the number of CPU cores and the resource group ID.                                                                                                                                                                                   |   6   |
|               | OOM Indicator                    | Number of OOM events observed in the corresponding cluster on the previous day.                                                                                                                                                                                                                 |   1   |